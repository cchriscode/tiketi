# Dev-only initContainers to wait for DB/Redis before startup

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-database
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database at $DB_HOST:$DB_PORT..."
              until nc -z $DB_HOST $DB_PORT; do
                echo "Database not ready, retrying..."
                sleep 2
              done
              echo "Database is ready!"
          env:
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_PORT
        - name: wait-for-cache
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for cache at $REDIS_HOST:$REDIS_PORT..."
              until nc -z $REDIS_HOST $REDIS_PORT; do
                echo "Cache not ready, retrying..."
                sleep 2
              done
              echo "Cache is ready!"
          env:
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: REDIS_HOST
            - name: REDIS_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: REDIS_PORT
---
# Auth Service - PostgreSQL
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-database
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database at $DB_HOST:$DB_PORT..."
              until nc -z $DB_HOST $DB_PORT; do
                echo "Database not ready, retrying..."
                sleep 2
              done
              echo "Database is ready!"
          env:
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_PORT
---
# Ticket Service - PostgreSQL and Dragonfly
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ticket-service
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-database
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database at $DB_HOST:$DB_PORT..."
              until nc -z $DB_HOST $DB_PORT; do
                echo "Database not ready, retrying..."
                sleep 2
              done
              echo "Database is ready!"
          env:
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_PORT
        - name: wait-for-cache
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for cache at $REDIS_HOST:$REDIS_PORT..."
              until nc -z $REDIS_HOST $REDIS_PORT; do
                echo "Cache not ready, retrying..."
                sleep 2
              done
              echo "Cache is ready!"
          env:
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: REDIS_HOST
            - name: REDIS_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: REDIS_PORT
---
# Payment Service - PostgreSQL
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-database
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database at $DB_HOST:$DB_PORT..."
              until nc -z $DB_HOST $DB_PORT; do
                echo "Database not ready, retrying..."
                sleep 2
              done
              echo "Database is ready!"
          env:
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_PORT
---
# Stats Service - PostgreSQL
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stats-service
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-database
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database at $DB_HOST:$DB_PORT..."
              until nc -z $DB_HOST $DB_PORT; do
                echo "Database not ready, retrying..."
                sleep 2
              done
              echo "Database is ready!"
          env:
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiketi-config
                  key: DB_PORT
