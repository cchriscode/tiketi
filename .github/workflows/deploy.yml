name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ========================================
  # Job 1: Frontend ë°°í¬ (ë³‘ë ¬ ì‹¤í–‰)
  # ========================================
  frontend:
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # OIDC í† í° ë°œê¸‰ ê¶Œí•œ
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm install

      - name: Build React app
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_SOCKET_URL: ${{ secrets.REACT_APP_SOCKET_URL }}
        run: |
          cd frontend
          npm run build

      - name: Upload to S3
        run: |
          # JS/CSS íŒŒì¼ (ê¸´ ìºì‹œ, íŒŒì¼ëª…ì— í•´ì‹œ í¬í•¨)
          aws s3 sync frontend/build s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # HTML íŒŒì¼ (ì§§ì€ ìºì‹œ)
          aws s3 sync frontend/build s3://${{ secrets.S3_BUCKET }}/ \
            --cache-control "max-age=0,no-cache,no-store,must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "*.json"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/index.html" "/asset-manifest.json"

      - name: Frontend deployment complete
        run: |
          echo "âœ… Frontend deployed successfully"
          echo "ğŸŒ S3 Bucket: ${{ secrets.S3_BUCKET }}"
          echo "ğŸ“¦ Build completed at: $(date)"

  # ========================================
  # Job 2: Backend ë¹Œë“œ & ECR í‘¸ì‹œ (ë³‘ë ¬ ì‹¤í–‰)
  # ========================================
  backend:
    name: Build Backend & Push to ECR
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # OIDC í† í° ë°œê¸‰ ê¶Œí•œ
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Build Docker image
        run: |
          cd backend
          docker build -f Dockerfile.prod \
            -t ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }} \
            -t ${{ env.ECR_REGISTRY }}/tiketi-backend:latest .

      - name: Push to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/tiketi-backend:latest

      - name: Backend build complete
        run: |
          echo "âœ… Backend image pushed successfully"
          echo "ğŸ³ Image: ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }}"
          echo "ğŸ“¦ Build completed at: $(date)"

  # ========================================
  # Job 3: EC2 ë°°í¬ (Self-hosted Runner)
  # ========================================
  deploy:
    name: Deploy to EC2
    needs: [frontend, backend]  # ë‘ Jobì´ ëª¨ë‘ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install/Update AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            echo "Installing AWS CLI..."

            # Install unzip if not present
            if ! command -v unzip &> /dev/null; then
              sudo apt-get update -qq
              sudo apt-get install -y unzip
            fi

            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          else
            echo "AWS CLI already installed: $(aws --version)"
          fi

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Cleanup old images before pull
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images and containers..."

          # ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ì‚­ì œ
          docker container prune -f

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì‚­ì œ
          docker image prune -af --filter "until=24h"

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì‚­ì œ
          docker volume prune -f

          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          echo "ğŸ“Š Disk usage:"
          df -h /var/lib/docker
          docker system df

      - name: Pull latest image
        run: |
          docker pull ${{ env.ECR_REGISTRY }}/tiketi-backend:latest

      - name: Deploy with docker-compose
        run: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

          echo "ğŸš€ Starting deployment..."
          cd /home/ubuntu/tiketi

          # ìµœì‹  backend ì´ë¯¸ì§€ë¥¼ docker-compose.prod.ymlì— ë°˜ì˜
          export BACKEND_IMAGE="${{ env.ECR_REGISTRY }}/tiketi-backend:latest"
          echo "ğŸ“¦ BACKEND_IMAGE: $BACKEND_IMAGE"

          # docker-compose.prod.ymlì˜ ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘/ì—…ë°ì´íŠ¸
          echo "ğŸ”„ Starting all services with docker compose..."
          docker compose -f docker-compose.prod.yml up -d

          # Health check (ìµœëŒ€ 60ì´ˆ)
          echo "ğŸ¥ Running health checks..."
          sleep 10

          # ë¨¼ì € ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
          echo "ğŸ“‹ Backend container logs:"
          docker logs tiketi-backend --tail 30

          for i in {1..15}; do
            if curl -f http://localhost:3001/health && \
               curl -f http://localhost:3001/health/db && \
               curl -f http://localhost:3001/health/redis; then
              echo "âœ… All health checks passed!"
              exit 0
            fi

            if [ $i -eq 5 ]; then
              echo "âš ï¸ Health check still failing, showing logs..."
              docker logs tiketi-backend --tail 50
            fi

            echo "â³ Waiting... ($i/15)"
            sleep 2
          done

          echo "âŒ Final health check failed"
          echo "ğŸ“‹ Full backend logs:"
          docker logs tiketi-backend --tail 100
          exit 1

      - name: Cleanup old images
        if: success()
        run: |
          docker image prune -af --filter "until=72h"
          echo "ğŸ§¹ Cleaned up old images"

      - name: Deployment successful
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“¦ Image: ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ• Time: $(date)"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ“‹ Check logs with: docker logs backend"
          echo "ğŸ” Debug: docker ps -a"

  # ========================================
  # Job 4: Discord ì•Œë¦¼ (ë°°í¬ ê²°ê³¼)
  # ========================================
  notify:
    name: Notify Discord
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ needs.deploy.result }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK is not set; skipping notification."
            exit 0
          fi

          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            COLOR="3066993"
            STATUS_TEXT="ì„±ê³µ"
          else
            EMOJI="âŒ"
            COLOR="15158332"
            STATUS_TEXT="ì‹¤íŒ¨"
          fi

          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

          cat <<EOF | curl -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
          {
            "username": "CI/CD Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [
              {
                "title": "${EMOJI} ë°°í¬ ${STATUS_TEXT}",
                "description": "AWS CI/CD íŒŒì´í”„ë¼ì¸ ë°°í¬ ê²°ê³¼",
                "color": ${COLOR},
                "fields": [
                  { "name": "ë¦¬í¬ì§€í† ë¦¬", "value": "${{ github.repository }}", "inline": true },
                  { "name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true },
                  { "name": "ì»¤ë°‹ ë©”ì‹œì§€", "value": "${{ github.event.head_commit.message }}", "inline": false },
                  { "name": "ì»¤ë°‹ SHA", "value": "${{ github.sha }}", "inline": true },
                  { "name": "í‘¸ì‹œí•œ ì‚¬ëŒ", "value": "${{ github.actor }}", "inline": true },
                  { "name": "ë°°í¬ í™˜ê²½", "value": "Production (AWS)", "inline": true },
                  { "name": "ë¡œê·¸ í™•ì¸", "value": "[GitHub Actions ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false }
                ],
                "timestamp": "${TIMESTAMP}"
              }
            ]
          }
          EOF
