name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ========================================
  # Job 1: Frontend ë°°í¬ (ë³‘ë ¬ ì‹¤í–‰)
  # ========================================
  frontend:
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # OIDC í† í° ë°œê¸‰ ê¶Œí•œ
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm install

      - name: Build React app
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        run: |
          cd frontend
          npm run build

      - name: Upload to S3
        run: |
          # JS/CSS íŒŒì¼ (ê¸´ ìºì‹œ, íŒŒì¼ëª…ì— í•´ì‹œ í¬í•¨)
          aws s3 sync frontend/build s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # HTML íŒŒì¼ (ì§§ì€ ìºì‹œ)
          aws s3 sync frontend/build s3://${{ secrets.S3_BUCKET }}/ \
            --cache-control "max-age=0,no-cache,no-store,must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "*.json"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/index.html" "/asset-manifest.json"

      - name: Frontend deployment complete
        run: |
          echo "âœ… Frontend deployed successfully"
          echo "ğŸŒ S3 Bucket: ${{ secrets.S3_BUCKET }}"
          echo "ğŸ“¦ Build completed at: $(date)"

  # ========================================
  # Job 2: Backend ë¹Œë“œ & ECR í‘¸ì‹œ (ë³‘ë ¬ ì‹¤í–‰)
  # ========================================
  backend:
    name: Build Backend & Push to ECR
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # OIDC í† í° ë°œê¸‰ ê¶Œí•œ
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Build Docker image
        run: |
          cd backend
          docker build -f Dockerfile.prod \
            -t ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }} \
            -t ${{ env.ECR_REGISTRY }}/tiketi-backend:latest .

      - name: Push to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/tiketi-backend:latest

      - name: Backend build complete
        run: |
          echo "âœ… Backend image pushed successfully"
          echo "ğŸ³ Image: ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }}"
          echo "ğŸ“¦ Build completed at: $(date)"

  # ========================================
  # Job 3: EC2 ë°°í¬ (Self-hosted Runner)
  # ========================================
  deploy:
    name: Deploy to EC2
    needs: [frontend, backend]  # ë‘ Jobì´ ëª¨ë‘ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    runs-on: self-hosted

    steps:
      - name: Install/Update AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            echo "Installing AWS CLI..."

            # Install unzip if not present
            if ! command -v unzip &> /dev/null; then
              sudo apt-get update -qq
              sudo apt-get install -y unzip
            fi

            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          else
            echo "AWS CLI already installed: $(aws --version)"
          fi

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Pull latest image
        run: |
          docker pull ${{ env.ECR_REGISTRY }}/tiketi-backend:latest

      - name: Deploy new container
        run: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

          echo "ğŸš€ Starting deployment..."

          # 0. ì‚¬ì „ ì •ë¦¬ - ì´ì „ ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì œê±°
          echo "ğŸ§¹ Cleaning up any existing backend-new container..."
          docker stop backend-new 2>/dev/null || true
          docker rm backend-new 2>/dev/null || true

          # 1. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ (í¬íŠ¸ 3003)
          echo "ğŸ“¦ Starting new container on port 3003..."
          docker run -d \
            --name backend-new \
            --network tiketi_network \
            -p 3003:3001 \
            --env-file /home/ubuntu/tiketi/.env \
            ${{ env.ECR_REGISTRY }}/tiketi-backend:latest

          # 2. Health check (30ì´ˆ íƒ€ì„ì•„ì›ƒ)
          echo "ğŸ¥ Running health checks..."
          sleep 10

          for i in {1..30}; do
            if curl -f -s http://localhost:3003/health > /dev/null; then
              echo "âœ… Health check passed!"
              break
            fi

            if [ $i -eq 30 ]; then
              echo "âŒ Health check failed after 30 attempts"
              docker logs backend-new --tail 50
              docker stop backend-new
              docker rm backend-new
              exit 1
            fi

            echo "â³ Waiting for service to be ready... ($i/30)"
            sleep 2
          done

          # 3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ Graceful Shutdown (60ì´ˆ ìœ ì˜ˆ)
          echo "ğŸ”„ Stopping old container gracefully..."
          docker stop --time=60 backend 2>/dev/null || echo "No existing container"
          docker rm backend 2>/dev/null || echo "No container to remove"

          # 4. ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ í¬íŠ¸ 3001ë¡œ ì¬ì‹œì‘
          echo "ğŸ”„ Switching to port 3001..."
          docker stop backend-new
          docker rm backend-new

          docker run -d \
            --name backend \
            --network tiketi_network \
            -p 3001:3001 \
            --env-file /home/ubuntu/tiketi/.env \
            --restart unless-stopped \
            ${{ env.ECR_REGISTRY }}/tiketi-backend:latest

          # 5. ìµœì¢… Health check
          echo "ğŸ¥ Final health check..."
          sleep 5
          for i in {1..15}; do
            if curl -f http://localhost:3001/health && \
               curl -f http://localhost:3001/health/db && \
               curl -f http://localhost:3001/health/redis; then
              echo "âœ… All health checks passed!"
              exit 0
            fi
            echo "â³ Waiting... ($i/15)"
            sleep 2
          done

          echo "âŒ Final health check failed"
          exit 1

      - name: Cleanup old images
        if: success()
        run: |
          docker image prune -af --filter "until=72h"
          echo "ğŸ§¹ Cleaned up old images"

      - name: Deployment successful
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“¦ Image: ${{ env.ECR_REGISTRY }}/tiketi-backend:${{ env.IMAGE_TAG }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ• Time: $(date)"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ“‹ Check logs with: docker logs backend"
          echo "ğŸ” Debug: docker ps -a"
